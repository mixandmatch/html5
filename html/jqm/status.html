<!DOCTYPE HTML>
<html>
    <head>
		<meta content="width=device-width,minimum-scale=1,maximum-scale=1" name="viewport"></meta>
    </head>

    <body>

        <div data-role="page" id="pageStatus">
            <div data-role="header" data-theme="b">
				<a href="index.html" data-icon="home" data-iconpos="notext" data-direction="reverse" class="ui-btn-left jqm-home">Home</a>
                <h1>Meine Verabredungen</h1>
            </div>

            <div data-role="content">
                <ul id="matches" data-role="listview">
                </ul>
                <br/>
            </div>

            <div data-role="footer">
                <h4>HTML Client</h4>
            </div>

			<script type="text/javascript">
 		
				JqmUtil.live('pageStatus', 'pageshow', function(){
					//$('div:jqmData(role="page")').live('pageshow', function(pEvent){
					//loadUserRequests();
                    $.mobile.showPageLoadingMsg();
                    
                    var userid = localStorage["userid"];
					//$('#name').val(userid);
					// FIXME per setter
					mixAndMatch.userid = userid;
                    
                    mixAndMatch.getMatchesForUser(function(pData) {
						$.mobile.hidePageLoadingMsg();
						showAllRequests(pData);
					});
				});
                
                
				function showAllRequests(userRequestsData) {
					log.debug('showAllRequests()');
				
					$.each(userRequestsData, function(index, entry) {
                        log.debug('handle log entry:', index);
                        var row = '<li>'
						row += '<h1>' +Utils.convertDate(entry.date, Utils.dateFormatInternal, Utils.dateFormatGui)+ '</h1>';
						row += '<h2>' +mixAndMatch.getLocationName(entry.locationKey)+ '</h2>';
						row += '<p>Teilnehmer: ' +entry.users+ '</p>';
                        row += '<div class="ui-li-count">'+entry.users.length+'</div>';
						row += '</li>';
                        $('#matches').append(row)
                        $('#matches').listview('refresh');
                        
					});
                    $('#matches').listview();
				}
 		
				function loadUserRequests(){
					$('#responseData').html('... loading data ...');
					$.mobile.showPageLoadingMsg();
					mixAndMatch.getLunchRequestsForUser(function(pData) {
						$.mobile.hidePageLoadingMsg();
						showUserRequestsCallback(pData);
					});
				}
		
				function showUserRequestObject(userRequestData){
					$('#requestData').html(
					userRequestData.name + ", " +
						userRequestData.email + ", "+
						Utils.convertDate(userRequestData.date, Utils.dateFormatInternal, Utils.dateFormatGui) + ", " +
						userRequestData.place);
				}
			
				function showUserRequestsCallback(userRequestsData) {
					log.debug('showUserRequestsCallback()');
				
					var content = '<table border="1">';
					$.each(userRequestsData, function(index, entry) {
						log.debug('handle log entry:', index);
						content += '<tr>';
						content += '<td>' +Utils.convertDate(entry.date, Utils.dateFormatInternal, Utils.dateFormatGui)+ '</td>';
						content += '<td>' +mixAndMatch.getLocationName(entry.locationKey)+ '</td>';
						content += '<td><a href="javascript:showDetailInformations(\''+entry.matchUrl+'\')">Teilnehmerliste</a></td>';
						content += '</tr>';
					});
					content += '</table>';

					$('#responseData').html(content);
				}
			
				function showDetailInformations(pMatchUrl) {
					log.debug('showDetailInformations() matchUrl:', pMatchUrl);
					$.mobile.showPageLoadingMsg();
				
					mixAndMatch.getMatchDetails(pMatchUrl, function(pMatchDetails) {
						$.mobile.hidePageLoadingMsg();

						var content = '<table border="1">';
						$.each(pMatchDetails, function(index, entry) {
							log.debug('log entry:', index);
							content += '<tr>';
							content += '<td>' +entry.userid+ '</td>';
							content += '</tr>';
						});
						content += '</table>';

						$('#detailData').html(content);
					});
				}
			
			</script>

        </div>
    </body>
</html>